<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Black Horse Wash - Application</title>
  <link rel="manifest" href="manifest.json">
  <style>
    body { margin:0; padding:0; font-family:Arial,sans-serif; background:#f5f5f5; color:#000; }
    header { display:flex; align-items:center; justify-content:center; background: linear-gradient(90deg,#2b8fe6 0%, #66b3ff 100%); padding:12px 20px; position:relative; }
    header img { height:84px; width:auto; }
    .cart-summary { position:absolute; right:16px; top:16px; color:#06314d; cursor:pointer; font-weight:700; background: rgba(255,255,255,0.92); padding:6px 10px; border-radius:10px; box-shadow:0 6px 14px rgba(3,34,56,0.12); }
    #auth-summary { position:absolute; right:150px; top:16px; color:#06314d; font-weight:700; display:flex; gap:8px; align-items:center; }
    #auth-summary button { background:transparent; border:1px solid rgba(6,49,77,0.06); padding:6px 10px; border-radius:8px; cursor:pointer; color:#06314d; }

main { padding:20px; margin-bottom:70px; }
section { display:none; padding:20px; background:#fff; border-radius:12px; box-shadow:0 4px 8px rgba(0,0,0,0.1); }
section.active { display:block; }
h1,h2 { margin-bottom:15px; text-align:center; }

.products-grid, .services-grid, .abonnement-grid { 
  display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:15px; 
}
.product-item, .service-item, .abonnement-item { 
  text-align:center; border-radius:12px; padding:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1); background:#fff; 
}
.product-item img, .service-item img {
  width:100%; display:block; aspect-ratio:4/3; object-fit:cover; object-position:center center; border-radius:8px; max-height:160px;
}
.abonnement-item img {
  width:100%; display:block; aspect-ratio:3/2; object-fit:cover; object-position:center center; border-radius:8px; max-height:120px;
}

.profile-grid { display:grid; grid-template-columns:1fr 1fr; gap:15px; }
.profile-grid input { width:100%; padding:8px; border-radius:6px; border:1px solid #ccc; }

.progress-container { background:#eee; border-radius:12px; overflow:hidden; margin-top:10px; }
.progress-bar { height:20px; width:0%; background:#000; text-align:center; color:#fff; line-height:20px; }

.photo-comparison { display:flex; flex-direction:row; gap:10px; margin-top:10px; }
.photo-comparison img { width:48%; height:auto; border-radius:8px; }

/* Bottom navigation - redesigned */
.bottom-nav { position:fixed; left:50%; transform:translateX(-50%); bottom:18px; background:linear-gradient(90deg,#0f4c81 0%, #1e90ff 100%); padding:8px 14px; border-radius:40px; display:flex; gap:18px; align-items:center; box-shadow:0 8px 20px rgba(11,97,166,0.18); z-index:110; }
.bottom-nav .nav-item { color:#fff; text-decoration:none; text-align:center; font-size:12px; display:flex; flex-direction:column; align-items:center; gap:6px; width:56px; padding:6px 4px; border-radius:12px; transition:transform .18s ease, background .18s ease; }
.bottom-nav .nav-item img { width:28px; height:28px; border-radius:6px; object-fit:cover; }
.bottom-nav .nav-item.active { background:rgba(212,175,55,0.12); transform:translateY(-4px) scale(1.03); box-shadow:0 8px 18px rgba(11,97,166,0.22); }
.bottom-nav .nav-item .label { font-size:11px; line-height:1; }

/* Floating FAB-style "Plus" button */
.fab-more { width:44px; height:44px; border-radius:50%; background:#1e90ff; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; box-shadow:0 8px 16px rgba(0,0,0,0.12); cursor:pointer; }

/* Modal/panel for additional links */
.more-modal { position:fixed; left:50%; transform:translateX(-50%) translateY(10px) scale(.98); bottom:86px; width:92%; max-width:420px; background:#fff; border-radius:12px; padding:12px; box-shadow:0 14px 40px rgba(0,0,0,0.28); z-index:120; opacity:0; visibility:hidden; transition:transform .26s cubic-bezier(.22,.9,.26,1), opacity .22s ease; transform-origin:50% 100%; }
.more-modal.open { opacity:1; visibility:visible; transform:translateX(-50%) translateY(0) scale(1); }
.more-modal h3 { margin:0 0 8px 0; }
.more-modal .more-list { display:flex; gap:10px; flex-wrap:wrap; }
.more-modal .more-list a { flex:1 1 45%; background:#f7f7f7; padding:10px; border-radius:8px; text-align:center; text-decoration:none; color:#111; transition:background .12s ease, transform .12s ease; }
.more-modal .more-list a:active { transform:translateY(1px); }

/* Product/service card hover / interactions for a more dynamic feel */
.product-item, .service-item {
  transition: transform .18s ease, box-shadow .18s ease;
}
.product-item:hover, .service-item:hover {
  transform: translateY(-6px) scale(1.02);
  box-shadow:0 10px 24px rgba(0,0,0,0.14);
}

.product-item button {
  background:#1e90ff; border:none; color:#fff; padding:8px 12px; border-radius:8px; cursor:pointer; transition:transform .12s ease, box-shadow .12s ease;
}
.product-item button:hover { transform:translateY(-2px); box-shadow:0 6px 12px rgba(0,0,0,0.12); }

/* small 'pop' animation when adding to cart */
@keyframes pop {
  0% { transform: scale(1); }
  40% { transform: scale(1.12); }
  100% { transform: scale(1); }
}
.product-item button.anim-pop { animation: pop .36s ease; }

/* FAB pulse when opening modal for a lively feel */
.fab-more.opening { animation: pulse 0.8s ease; }
@keyframes pulse { 0% { transform:scale(1); } 50% { transform:scale(1.08);} 100% { transform:scale(1);} }

/* allow svg sizing in nav */
.bottom-nav .nav-item svg { width:28px; height:28px; display:block; }
.bottom-nav .nav-item { color:#fff; }
.bottom-nav .nav-item.active svg { fill:#66b3ff; }

@media(max-width:480px){
  .bottom-nav { width:calc(100% - 36px); left:18px; transform:none; border-radius:12px; }
}

#home img { width:100%; max-width:350px; height:auto; display:block; margin:0 auto; border-radius:12px; }

/* Titre principal */
#home h1 {
  font-family: 'Cinzel', serif;
  font-size: 3rem;
  color: #0b61a6; /* deep blue for a fresher look */
  text-align: center;
  letter-spacing: 3px;
  font-weight: 700;
  text-transform: uppercase;
  margin-top: 30px;
  margin-bottom: 50px;
  position: relative;
  display: block;
  z-index: 10;
  -webkit-text-stroke: 1.2px rgba(8,30,60,0.9);
  text-shadow: 0 6px 14px rgba(11,97,166,0.12);
}
#home h1::after {
  content: "";
  display: block;
  width: 80px;
  height: 4px;
  background-color: #1e90ff;
  margin: 10px auto 0;
  border-radius: 2px;
}

/* Cart modal */
.cart-modal { position:fixed; right:16px; top:64px; width:320px; max-width:90vw; background:#fff; border-radius:12px; box-shadow:0 18px 40px rgba(3,34,56,0.18); z-index:130; padding:12px; display:none; }
.cart-modal.open { display:block; }
.cart-modal h4 { margin:0 0 8px 0; }
.cart-modal .cart-items { max-height:260px; overflow:auto; margin-bottom:8px; }
.cart-modal .cart-items li { display:flex; justify-content:space-between; padding:8px 6px; border-bottom:1px solid #f1f1f1; }
.cart-modal .cart-footer { display:flex; justify-content:space-between; align-items:center; }
.cart-modal button { background:#1e90ff; color:#fff; border:none; padding:8px 10px; border-radius:8px; cursor:pointer; }

/* subscription badge */
.badge-sub { display:inline-block; background:#e6f2ff; color:#0b61a6; font-size:11px; padding:2px 8px; border-radius:999px; margin-left:6px; vertical-align:middle; }
.badge-sub[title]{ position:relative; }
.badge-sub[title]:hover::after{ content: attr(title); position:absolute; left:50%; transform:translateX(-50%); bottom:calc(100% + 8px); background:#06314d; color:#fff; padding:6px 8px; font-size:12px; border-radius:6px; white-space:nowrap; box-shadow:0 6px 18px rgba(3,34,56,0.12); }

/* helper text under Abonnements */
.ab-help { text-align:center; color:#06314d; font-size:14px; margin-top:6px; margin-bottom:12px; }

/* quantity controls inside cart */
.qty-btn { background:#fff; border:1px solid #e3e6ea; padding:4px 8px; border-radius:6px; cursor:pointer; color:#06314d; font-weight:600; }
.qty-num { margin:0 8px; min-width:24px; display:inline-block; text-align:center; }

@media(max-width:768px){ 
  .profile-grid { grid-template-columns:1fr; } 
  .photo-comparison { flex-direction:column; } 
}
@media(max-width:480px){
  .services-grid img, .products-grid img { height:140px; }
  .abonnement-grid img { height:100px; }
}

/* RDV visual calendar styles */
.rdv-calendar { display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:10px; margin-top:8px; }
.rdv-day { background:#fbfdff; border:1px solid #e6f6ff; padding:8px; border-radius:8px; }
.rdv-day-header { font-weight:700; font-size:13px; color:#06314d; margin-bottom:6px; }
.rdv-day-slots { display:flex; flex-wrap:wrap; gap:6px; }
.rdv-slot-btn { background:#fff; border:1px solid #dbeffb; padding:6px 8px; border-radius:6px; cursor:pointer; font-weight:600; color:#0b61a6; }
.rdv-slot-btn:hover { transform:translateY(-2px); box-shadow:0 6px 14px rgba(2,80,160,0.08); }
.rdv-slot-btn.selected { background:#1e90ff; color:#fff; border-color:#1e90ff; }
.rdv-slot-btn:disabled, .rdv-slot-btn.taken { background:#f1f5f9; color:#9aa7b8; border-color:#e6eef6; cursor:not-allowed; }

/* legend for slot states */
.rdv-legend { display:flex; gap:10px; align-items:center; margin-top:8px; margin-bottom:6px; }
.legend-item { display:flex; gap:8px; align-items:center; font-size:13px; color:#06314d; }
.legend-swatch { width:18px; height:18px; border-radius:4px; border:1px solid #dbeffb; display:inline-block; }
.legend-available { background:#fff; border-color:#dbeffb; }
.legend-selected { background:#1e90ff; border-color:#1e90ff; }
.legend-taken { background:#f1f5f9; border-color:#e6eef6; }

/* tweak RDV nav svg visual style specifically */
.bottom-nav .nav-item[data-target="rdv"] svg { background: rgba(255,255,255,0.06); padding:4px; border-radius:6px; }
.bottom-nav .nav-item[data-target="rdv"].active svg { background: rgba(255,255,255,0.12); }

</style>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const authBtnBottom = document.getElementById('auth-btn-bottom');
    const profileTabBottom = document.getElementById('profile-tab-bottom');
    const profilSection = document.getElementById('profil');

    if (!authBtnBottom || !profileTabBottom || !profilSection) return;

    function updateUI() {
      const user = JSON.parse(localStorage.getItem('bhw_current_user') || 'null');
      const label = authBtnBottom.querySelector('.label');

      if(user){
        if(label) label.textContent = user.name || user;
        profileTabBottom.style.display = 'flex';
        profilSection.style.display = 'block';
        try{ profilSection.querySelector('input[placeholder="Nom du client"]').value = user.name || ''; }catch(e){}
        try{ profilSection.querySelector('input[placeholder="Modèle du véhicule"]').value = user.vehicle || ''; }catch(e){}
        try{ profilSection.querySelector('input[placeholder="Adresse"]').value = user.address || ''; }catch(e){}
        try{ renderMaintenanceLog(); }catch(e){}
      } else {
        if(label) label.textContent = 'Se connecter';
        profileTabBottom.style.display = 'none';
        profilSection.style.display = 'none';
      }
    }

    updateUI();

    authBtnBottom.addEventListener('click', function(e){
      e.preventDefault();
      const user = JSON.parse(localStorage.getItem('bhw_current_user') || 'null');
      if(user){
        localStorage.removeItem('bhw_current_user');
        updateUI();
      } else {
        openAuthModal();
      }
    });

    profileTabBottom.addEventListener('click', function(e){
      e.preventDefault();
      profilSection.scrollIntoView({behavior:'smooth'});
    });
  });
  </script>
</head>
<body>

<header>
  <img src="image/logo.jpg" alt="Logo Black Horse Wash">
  <div class="cart-summary" onclick="showCart()" role="button" aria-label="Ouvrir le panier">
    Panier: <span id="cart-count">0</span>
  </div>
  <div id="auth-btn" class="cart-summary" onclick="openAuthModal()" role="button" aria-label="Se connecter" style="right:110px;">Se connecter</div>
</header>

<main>
 
  <!-- ACCUEIL -->
  <section id="home" class="active">
    <h1>Black Horse Wash</h1>
    <img src="image/CarWash.jpg" alt="Car Wash">
  </section>

<!-- PROFIL -->
<section id="profil" style="display:none;">
  <h2>Profil Client</h2>
  <div class="profile-grid">
    <!-- informations du client -->
    <div><label>Nom</label><input type="text" placeholder="Nom du client"></div>
    <div><label>Véhicule</label><input type="text" placeholder="Modèle du véhicule"></div>
    <div><label>Adresse</label><input type="text" placeholder="Adresse"></div>
    <div><label>Prochain RDV</label><input type="datetime-local"></div>

    <!-- Actions supplémentaires -->
    <div id="profil-next-actions" style="grid-column: 1/-1; margin-top: 8px;"></div>

    <!-- Abonnements actifs -->
    <div style="grid-column:1/-1;">
      <h3>Abonnements actifs</h3>
      <ul id="subscriptions-list" style="margin:8px 0 0 0; padding-left:18px;"></ul>
    </div>

    <!-- Points fidélité -->
    <div>
      <label>Points fidélité</label>
      <div class="progress-container" style="background:#eee; border-radius:6px; width:100%; height:20px;">
        <div class="progress-bar" style="width:40%; background:#4CAF50; text-align:center; color:white; line-height:20px; border-radius:6px;">
          40 pts
        </div>
      </div>
    </div>
  </div>
  <div id="maintenance-log" style="margin-top:12px;border-top:1px solid #e6eef9;padding-top:12px;">
    <h3 style="margin:0 0 8px 0;">Carnet d'entretien</h3>
    <div style="margin-bottom:8px;">
      <label style="font-size:13px;">Ajouter une note / photos</label>
      <textarea id="maint-note" placeholder="Notes..." style="width:100%;height:80px;margin-top:6px;padding:8px;border:1px solid #ddd;border-radius:6px;"></textarea>
      <input type="file" id="maint-photos" accept="image/*" multiple style="margin-top:8px;" />
      <div style="margin-top:8px;"><button onclick="addMaintenanceEntryFromForm()">Ajouter</button></div>
    </div>
    <div id="maintenance-log-list"></div>
  </div>
</section>

  <!-- SERVICES -->
  <section id="services">
    <h2>Services</h2>
      <div class="services-grid">
        <div class="service-item"><img src="image/interieur-voiture.jpg" alt="Intérieur Voiture" loading="lazy"><h3>Intérieur Voiture</h3><p>20€</p></div>
        <div class="service-item"><img src="image/exterieur-voiture.jpg" alt="Extérieur Voiture" loading="lazy"><h3>Extérieur Voiture</h3><p>15€</p></div>
        <div class="service-item"><img src="image/lavage-les-2.jpg" alt="Nettoyage Complet" loading="lazy"><h3>Nettoyage Complet</h3><p>30€</p></div>
      </div>
  </section>

  <!-- PRODUITS -->
  <section id="products">
    <h2>Produits à la vente</h2>
      <div class="products-grid">
    <div class="product-item"><img src="image/shampoo-car.jpg" alt="Shampooing" loading="lazy"><h3>Shampooing</h3><p>10 €</p><button data-price="10" onclick="addToCart(this,'Shampooing')">Ajouter au panier</button></div>
    <div class="product-item"><img src="image/lustrant-voiture.jpg" alt="Lustrant" loading="lazy"><h3>Lustrant</h3><p>15 €</p><button data-price="15" onclick="addToCart(this,'Lustrant')">Ajouter au panier</button></div>
    <div class="product-item"><img src="image/micro-fibre.jpg" alt="Microfibre" loading="lazy"><h3>Microfibre</h3><p>5 €</p><button data-price="5" onclick="addToCart(this,'Microfibre')">Ajouter au panier</button></div>
      </div>
  </section>

  <!-- RDV -->
  <section id="rdv">
    <h2>Demande de RDV</h2>
    <label>Client</label><input id="rdv-client" type="text" placeholder="Nom du client">
    <label>Véhicule</label><input id="rdv-vehicle" type="text" placeholder="Modèle du véhicule">
    <label>Service demandé</label>
    <select id="rdv-service" onchange="updateRdvPricePreview()">
      <option value="interieur">Intérieur Voiture</option>
      <option value="exterieur">Extérieur Voiture</option>
      <option value="complet">Nettoyage Complet</option>
    </select>
    <label>Options supplémentaires</label>
    <div id="rdv-options" style="display:flex;gap:10px;flex-wrap:wrap;margin-top:6px;">
      <label style="font-size:14px;"><input type="checkbox" value="siege-bebe" id="opt-siege" data-price="5" onchange="updateRdvPricePreview()"> Siège bébé (+5€)</label>
      <label style="font-size:14px;"><input type="checkbox" value="poils-animaux" id="opt-poils" data-price="7" onchange="updateRdvPricePreview()"> Poils d'animaux (+7€)</label>
    </div>
    <div style="margin-top:8px;font-size:14px;color:#06314d">Prix estimé: <span id="rdv-price-preview">0 €</span></div>
  <label>Choisir une date/une plage horaire</label>
    <!-- Use native datetime-local picker (same as Profil) so RDV UI matches Profil -->
    <input id="rdv-slot" type="datetime-local">
    <label>Paiement</label>
    <select id="rdv-payment">
      <option>Carte bancaire</option>
      <option>Espèces</option>
      <option>PayPal</option>
    </select>
    <div style="margin-top:10px"><button onclick="submitRdv()">Demander RDV</button></div>

  <hr>
  <label style="display:none;"><input type="checkbox" id="admin-mode" onchange="toggleAdminMode(this.checked)"> Mode patron (afficher demandes en attente)</label>
    <div id="pending-rdvs" style="margin-top:12px; display:none;"></div>
    <div id="my-pending-container" style="margin-top:12px;">
      <h3>Mes demandes en attente</h3>
      <div id="my-pending-rdvs">Vous n'avez pas encore de demande.</div>
    </div>

  </section>

  <!-- AVANCÉ -->
  <section id="avance">
    <h2>Avancement du RDV</h2>
    <div class="progress-container"><div class="progress-bar" style="width:50%;">50%</div></div>
    <h3>Photos Avant / Après</h3>
    <div class="photo-comparison">
      <div><p>Avant</p><img src="image/shampoo-car.jpg" alt="Avant"></div>
      <div><p>Après</p><img src="image/lustrant-voiture.jpg" alt="Après"></div>
    </div>
    <p>Nom du professionnel : Jean Dupont</p>
  </section>

  <!-- MAPS -->
  <section id="maps">
    <h2>Maps</h2>
    <iframe src="https://maps.google.com/maps?q=Paris&t=&z=13&ie=UTF8&iwloc=&output=embed" style="width:100%;height:300px;border:0;border-radius:12px;"></iframe>
  </section>

  <!-- ABONNEMENTS -->
  <section id="abonnements">
    <h2>Abonnements</h2>
    <p class="ab-help">Les abonnements doivent être payés pour être activés. Ils apparaîtront dans votre profil après le paiement.</p>
    <div class="abonnement-grid">
      <div class="abonnement-item"><img src="image/abonnement-basic.jpg" alt="Basic"><p>Basic - 10€</p><button data-price="10" onclick="addSubscription(this,'Basic',10)">Ajouter au panier (abonnement)</button></div>
      <div class="abonnement-item"><img src="image/abonnement-medium.jpg" alt="Medium"><p>Medium - 20€</p><button data-price="20" onclick="addSubscription(this,'Medium',20)">Ajouter au panier (abonnement)</button></div>
      <div class="abonnement-item"><img src="image/abonnement-premium.jpg" alt="Premium"><p>Premium - 30€</p><button data-price="30" onclick="addSubscription(this,'Premium',30)">Ajouter au panier (abonnement)</button></div>
    </div>
    <!-- maintenance log moved to Profil section -->
  </section>

<nav class="bottom-nav" role="navigation" aria-label="Navigation principale">
  <!-- Accueil -->
  <a href="#" class="nav-item" data-target="home" onclick="showSection('home');return false;" aria-label="Accueil">
    <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
      <path fill="currentColor" d="M12 3l9 7v8a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1V10l9-7z"/>
    </svg>
    <span class="label">Accueil</span>
  </a>

  <!-- Services -->
  <a href="#" class="nav-item" data-target="services" onclick="showSection('services');return false;" aria-label="Services">
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
      <path fill="currentColor" d="M5 16c-.6 0-1-.4-1-1V10c0-1.1.9-2 2-2h1V6c0-.6.4-1 1-1h1c.6 0 1 .4 1 1v2h2V6c0-.6.4-1 1-1h1c.6 0 1 .4 1 1v2h1c1.1 0 2 .9 2 2v5c0 .6-.4 1-1 1h-1v1c0 .6-.4 1-1 1H7c-.6 0-1-.4-1-1v-1H5zm2-4a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm8 0a1 1 0 1 0 0 2 1 1 0 0 0 0-2zM7 9h10v1H7V9zm11.5-4.5c-.3.3-.8.3-1.1 0-.3-.3-.3-.8 0-1.1.3-.3.8-.3 1.1 0 .3.3.3.8 0 1.1zm-3 0c-.3.3-.8.3-1.1 0-.3-.3-.3-.8 0-1.1.3-.3.8-.3 1.1 0 .3.3.3.8 0 1.1z"/>
    </svg>
    <span class="label">Services</span>
  </a>

  <!-- Produits -->
  <a href="#" class="nav-item" data-target="products" onclick="showSection('products');return false;" aria-label="Produits">
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
      <path fill="currentColor" d="M6 2h12l1.6 4H4.4L6 2zM5 8h14v12a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V8zm6 2a3 3 0 0 1 3 3h-2a1 1 0 1 0-2 0H8a3 3 0 0 1 3-3z"/>
    </svg>
    <span class="label">Produits</span>
  </a>

  <!-- RDV -->
  <a href="#" class="nav-item" data-target="rdv" onclick="showSection('rdv');return false;" aria-label="Réserver">
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
      <path fill="currentColor" d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zM5 9h14v11H5V9zM7 11h5v5H7z"/>
    </svg>
    <span class="label">RDV</span>
  </a>

<!-- Profil -->
<a href="#" class="nav-item" id="profile-tab-bottom" data-target="profil" style="display:none;" onclick="showSection('profil');return false;" aria-label="Profil">
  <svg viewBox="0 0 24 24" width="26" height="26" fill="currentColor" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
    <path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4zm0 2c-4 0-7 2-7 4v2h14v-2c0-2-3-4-7-4z"/>
  </svg>
  <span class="label">Profil</span>
</a>

  <!-- Compte (auth) - required by JS to toggle auth/profile UI -->
  <a href="#" class="nav-item" id="auth-btn-bottom" onclick="(function(e){e.preventDefault(); const user = JSON.parse(localStorage.getItem('bhw_current_user')||'null'); if(user){ setCurrentUser(null); showToast('Déconnecté'); } else { openAuthModal(); } })();return false;" aria-label="Compte">
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
      <path fill="currentColor" d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5zm0 2c-5 0-9 2.5-9 5v1h18v-1c0-2.5-4-5-9-5z"/>
    </svg>
    <span class="label">Compte</span>
  </a>

  <!-- Promo / Concours -->
  <a href="#" class="nav-item" data-target="promo" onclick="showSection('promo');return false;" aria-label="Promotions / Concours">
    <!-- Exemple SVG : étoile / coupon -->
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
      <path fill="currentColor" d="M12 2L15 8H9L12 2ZM12 22L9 16H15L12 22ZM2 12L8 15V9L2 12ZM22 12L16 9V15L22 12Z"/>
    </svg>
    <span class="label">Promo / Concours</span>
  </a>

  <!-- Bouton Plus -->
  <div class="fab-more" role="button" aria-label="Plus" onclick="toggleMore();">+</div>
</nav>

<!-- Section pour Promo / Concours -->
<section id="promo" style="display:none;">
  <h2>Promotions et concours en cours</h2>
  <p>Ajoutez ici toutes vos promotions, concours et offres spéciales.</p>
</section>

<!-- More modal: regroupe les sections moins utilisées -->
<div id="more-modal" class="more-modal" aria-hidden="true">
  <h3>Plus</h3>
  <div class="more-list">
    <a href="#" onclick="showSection('avance');toggleMore();return false;">Avancement</a>
    <a href="#" onclick="showSection('maps');toggleMore();return false;">Maps</a>
    <a href="#" onclick="showSection('abonnements');toggleMore();return false;">Abonnements</a>
    <a href="#" onclick="document.getElementById('more-modal').classList.remove('open');document.getElementById('more-modal').setAttribute('aria-hidden','true');return false;">Fermer</a>
  </div>
</div>
</main>
<!-- Auth modal (demo localStorage accounts) -->
<div id="auth-modal" style="display:none; position:fixed; left:50%; transform:translateX(-50%); top:14%; width:92%; max-width:420px; background:#fff; border-radius:12px; padding:12px; box-shadow:0 18px 40px rgba(3,34,56,0.18); z-index:150;">
  <h3 id="auth-title">Se connecter</h3>
  <div style="display:flex;gap:8px;margin-bottom:8px;">
    <button id="auth-tab-login" onclick="showAuthTab('login')" style="flex:1;padding:8px;border-radius:8px;border:1px solid #eee;">Connexion</button>
    <button id="auth-tab-register" onclick="showAuthTab('register')" style="flex:1;padding:8px;border-radius:8px;border:1px solid #eee;">Inscription</button>
  </div>
  <div id="auth-body">
    <div id="auth-login" style="display:block;">
      <label>Email</label>
      <input id="auth-login-email" type="email" style="width:100%;padding:8px;margin:6px 0;border-radius:6px;border:1px solid #ddd;">
      <label>Mot de passe</label>
      <input id="auth-login-pass" type="password" style="width:100%;padding:8px;margin:6px 0;border-radius:6px;border:1px solid #ddd;">
      <div style="margin-top:8px;display:flex;gap:8px;"><button onclick="loginUser()" style="flex:1;background:#1e90ff;color:#fff;padding:8px;border-radius:8px;border:none;">Connexion</button><button onclick="closeAuthModal()" style="flex:1;background:transparent;border:1px solid #ddd;padding:8px;border-radius:8px;">Fermer</button></div>
    </div>
    <div id="auth-register" style="display:none;">
      <label>Nom</label>
      <input id="auth-reg-name" type="text" style="width:100%;padding:8px;margin:6px 0;border-radius:6px;border:1px solid #ddd;">
      <label>Email</label>
      <input id="auth-reg-email" type="email" style="width:100%;padding:8px;margin:6px 0;border-radius:6px;border:1px solid #ddd;">
      <label>Mot de passe</label>
      <input id="auth-reg-pass" type="password" style="width:100%;padding:8px;margin:6px 0;border-radius:6px;border:1px solid #ddd;">
      <label>Rôle</label>
      <select id="auth-reg-role" style="width:100%;padding:8px;margin:6px 0;border-radius:6px;border:1px solid #ddd;"><option value="client">Client</option><option value="patron">Patron (démo)</option></select>
      <div style="margin-top:8px;display:flex;gap:8px;"><button onclick="registerUser()" style="flex:1;background:#1e90ff;color:#fff;padding:8px;border-radius:8px;border:none;">Créer</button><button onclick="closeAuthModal()" style="flex:1;background:transparent;border:1px solid #ddd;padding:8px;border-radius:8px;">Fermer</button></div>
      <div style="margin-top:8px;font-size:12px;color:#666">Note: il s'agit d'une démo. Les comptes sont stockés localement et non sécurisés.</div>
    </div>
  </div>
  <div style="margin-top:8px;text-align:right;"><button id="auth-logout" onclick="logoutUser()" style="display:none;background:transparent;border:none;color:#d00;">Déconnexion</button></div>
</div>
<!-- manage tariffs button (owner only) -->
<button id="auth-manage-tariffs" onclick="openTariffsModal()" style="display:none; position:fixed; right:18px; top:86px; background:#06314d;color:#fff;padding:8px;border-radius:8px;border:none; z-index:160;">Gérer tarifs</button>

<!-- Tariffs modal (owner only) -->
<div id="tariffs-modal" style="display:none; position:fixed; left:50%; transform:translateX(-50%); top:12%; width:92%; max-width:520px; background:#fff; border-radius:12px; padding:12px; box-shadow:0 20px 50px rgba(3,34,56,0.22); z-index:160;">
  <h3>Gérer les tarifs</h3>
  <div style="display:grid;grid-template-columns:1fr 90px;gap:8px;align-items:center;">
    <label>Intérieur (€)</label><input id="tariff-interieur" type="number" step="0.01" style="padding:8px;border-radius:6px;border:1px solid #ddd;">
    <label>Extérieur (€)</label><input id="tariff-exterieur" type="number" step="0.01" style="padding:8px;border-radius:6px;border:1px solid #ddd;">
    <label>Complet (€)</label><input id="tariff-complet" type="number" step="0.01" style="padding:8px;border-radius:6px;border:1px solid #ddd;">
    <label>Siège bébé (€)</label><input id="tariff-siege-bebe" type="number" step="0.01" style="padding:8px;border-radius:6px;border:1px solid #ddd;">
    <label>Poils d'animaux (€)</label><input id="tariff-poils-animaux" type="number" step="0.01" style="padding:8px;border-radius:6px;border:1px solid #ddd;">
  </div>
  <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end;"><button onclick="saveTariffs()" style="background:#1e90ff;color:#fff;padding:8px;border-radius:8px;border:none;">Enregistrer</button><button onclick="closeTariffsModal()" style="background:transparent;border:1px solid #ddd;padding:8px;border-radius:8px;">Fermer</button></div>
</div>

<!-- Cart modal -->
<div id="cart-modal" class="cart-modal" aria-hidden="true">
  <h4>Panier</h4>
  <ul class="cart-items" id="cart-items-list"></ul>
  <div class="cart-footer">
    <div id="cart-total">Total: 0 €</div>
    <div>
      <button onclick="checkout()">Payer</button>
    </div>
  </div>
</div>

<footer>© 2025 Black Horse Wash</footer>

<script>
let cartCount = 0;
let cart = JSON.parse(localStorage.getItem('bhw_cart') || '[]');
let subscriptions = JSON.parse(localStorage.getItem('bhw_subscriptions') || '[]');
// Tariffs configuration (default). Persisted in localStorage 'bhw_tariffs'
const DEFAULT_TARIFFS = {
  services: { interieur: 20, exterieur: 15, complet: 30 },
  options: { 'siege-bebe': 5, 'poils-animaux': 7 }
};
let tariffs = JSON.parse(localStorage.getItem('bhw_tariffs') || 'null') || DEFAULT_TARIFFS;
// initialize cartCount from stored cart
cartCount = cart.reduce((s,i)=>s + (i.qty||1), 0);
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('cart-count').textContent = cartCount;
  renderCart();
  renderSubscriptions();
});
function addToCart(buttonOrName, productName, priceParam, typeParam){
  // Support calling addToCart(this, 'Name') or addToCart('Name') for backwards compatibility
  let btn = null;
  let name = productName;
  if (typeof buttonOrName === 'object' && buttonOrName !== null && buttonOrName.tagName){
    btn = buttonOrName;
  } else {
    name = buttonOrName;
  }

  // determine price and type
  const nameKey = name || productName;
  let price = 0;
  if (priceParam !== undefined) price = Number(priceParam) || 0;
  else if (btn && btn.dataset && btn.dataset.price) price = Number(btn.dataset.price) || 0;
  const type = typeParam || (btn && btn.dataset && btn.dataset.type) || 'product';

  // update cart data structure and persist
  const existing = cart.find(i=>i.name === nameKey && i.type === type);
  if (existing) existing.qty = (existing.qty||1)+1;
  else cart.push({ name: nameKey, qty: 1, price: price, type: type });
  try { localStorage.setItem('bhw_cart', JSON.stringify(cart)); } catch(e){ console.warn('LocalStorage error', e); }
  cartCount = cart.reduce((s,i)=>s + (i.qty||1), 0);
  document.getElementById('cart-count').textContent = cartCount;

  // animate button if provided
  if (btn) {
    btn.classList.add('anim-pop');
    setTimeout(() => btn.classList.remove('anim-pop'), 400);
  }

  // Friendly toast instead of alert
  showToast((name || productName) + " ajouté au panier !");
  renderCart();
}

function renderCart(){
  const list = document.getElementById('cart-items-list');
  const totalEl = document.getElementById('cart-total');
  if(!list) return;
  list.innerHTML = '';
  let total = 0;
  if(cart.length === 0){
    const li = document.createElement('li'); li.textContent = 'Panier vide'; list.appendChild(li); total = 0;
  } else {
    cart.forEach((item, idx)=>{
      const li = document.createElement('li');
      const priceText = item.price ? (item.price * (item.qty||1)).toFixed(2) + ' €' : '';
  const badge = item.type === 'subscription' ? '<span class="badge-sub" title="Abonnement — nécessite paiement et activation après paiement">Abonnement</span>' : '';
      li.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="flex:1">
            <div style="font-weight:600">${item.name} ${badge}</div>
            <div style="color:#666;font-size:12px;margin-top:4px">Prix unitaire: ${item.price? (item.price.toFixed(2)+' €') : '-'}</div>
          </div>
          <div style="display:flex;align-items:center;gap:8px">
            <button class="qty-btn" onclick="changeCartQty(${idx},-1)" aria-label="Réduire la quantité">−</button>
            <div class="qty-num">${item.qty||1}</div>
            <button class="qty-btn" onclick="changeCartQty(${idx},1)" aria-label="Augmenter la quantité">+</button>
            <div style="width:10px"></div>
            <div style="text-align:right">${priceText}<br><button onclick="removeCartItem(${idx})" style="margin-top:6px;background:transparent;border:none;color:#d00;cursor:pointer">Suppr</button></div>
          </div>
        </div>
      `;
      list.appendChild(li);
      total += (item.price||0) * (item.qty||1);
    });
  }
  totalEl.textContent = `Total: ${total.toFixed(2)} €`;
}

function removeCartItem(index){
  if(index < 0 || index >= cart.length) return;
  cart.splice(index,1);
  try{ localStorage.setItem('bhw_cart', JSON.stringify(cart)); } catch(e){}
  cartCount = cart.reduce((s,i)=>s + (i.qty||1), 0);
  document.getElementById('cart-count').textContent = cartCount;
  renderCart();
}

function changeCartQty(index, delta){
  if(index < 0 || index >= cart.length) return;
  const item = cart[index];
  item.qty = (item.qty || 1) + delta;
  if(item.qty <= 0){
    // remove item if quantity drops to 0
    cart.splice(index,1);
  }
  try{ localStorage.setItem('bhw_cart', JSON.stringify(cart)); } catch(e){}
  cartCount = cart.reduce((s,i)=>s + (i.qty||1), 0);
  document.getElementById('cart-count').textContent = cartCount;
  renderCart();
}

function showCart(){
  const modal = document.getElementById('cart-modal');
  if(!modal) return;
  const opened = modal.classList.toggle('open');
  modal.setAttribute('aria-hidden', opened ? 'false' : 'true');
  if(opened) renderCart();
}

function checkout(){
  // Simulated checkout: process subscriptions into profile, then clear cart
  if(cart.length === 0){ showToast('Le panier est vide'); return; }
  // Move subscription items to subscriptions list
  const subsToAdd = cart.filter(i=>i.type === 'subscription');
  if(subsToAdd.length){
    subsToAdd.forEach(s => subscriptions.push({ name: s.name, price: s.price || 0, date: new Date().toISOString() }));
    try{ localStorage.setItem('bhw_subscriptions', JSON.stringify(subscriptions)); } catch(e){}
  }
  // In a real flow you'd create an order and charge the user here
  cart = [];
  try{ localStorage.setItem('bhw_cart', JSON.stringify(cart)); } catch(e){}
  cartCount = 0; document.getElementById('cart-count').textContent = cartCount;
  renderCart();
  renderSubscriptions();
  showToast('Merci pour votre achat ! (simulé)');
}

function addSubscription(btnOrName, subName, price){
  // Clicking "S'abonner" should add the subscription to the cart (so the client pays),
  // not directly to the profile. After checkout subscription items will be moved to profile.
  // Support calling addSubscription(this,'Basic',10) or addSubscription('Basic',10)
  let btn = null;
  let name = subName;
  if (typeof btnOrName === 'object' && btnOrName !== null && btnOrName.tagName) {
    btn = btnOrName;
  } else if (typeof btnOrName === 'string') {
    name = btnOrName;
  }
  const sName = name || subName;
  // Add to cart as subscription type; addToCart will persist and update UI
  addToCart(btn || sName, sName, price, 'subscription');
}

function renderSubscriptions(){
  const el = document.getElementById('subscriptions-list');
  if(!el) return;
  el.innerHTML = '';
  if(!subscriptions || subscriptions.length === 0){ el.innerHTML = '<li>Aucun abonnement</li>'; return; }
  subscriptions.forEach((s, idx)=>{
    const li = document.createElement('li');
    li.innerHTML = `${s.name} (${new Date(s.date).toLocaleDateString()}) <button onclick="removeSubscription(${idx})" style="margin-left:8px;background:transparent;border:none;color:#d00;cursor:pointer">Suppr</button>`;
    el.appendChild(li);
  });
}

function removeSubscription(index){
  if(!subscriptions || index < 0 || index >= subscriptions.length) return;
  subscriptions.splice(index,1);
  try{ localStorage.setItem('bhw_subscriptions', JSON.stringify(subscriptions)); } catch(e){}
  renderSubscriptions();
  showToast('Abonnement supprimé');
}

// small toast implementation
function showToast(message){
  let t = document.getElementById('bhw-toast');
  if (!t){
    t = document.createElement('div');
    t.id = 'bhw-toast';
    t.style.position = 'fixed';
    t.style.right = '20px';
    t.style.bottom = '90px';
    t.style.background = 'rgba(0,0,0,0.75)';
    t.style.color = '#fff';
    t.style.padding = '10px 14px';
    t.style.borderRadius = '10px';
    t.style.zIndex = 9999;
    t.style.fontSize = '14px';
    document.body.appendChild(t);
  }
  t.textContent = message;
  t.style.opacity = '1';
  clearTimeout(t._timeout);
  t._timeout = setTimeout(()=>{ t.style.transition = 'opacity .4s ease'; t.style.opacity='0'; }, 1800);
}
function showSection(id){
  // Affiche la section demandée (single-page behavior)
  document.querySelectorAll('main section').forEach(sec => sec.classList.remove('active'));
  const target = document.getElementById(id);
  if(target) target.classList.add('active');

  // Met à jour l'état actif du menu
  document.querySelectorAll('.bottom-nav .nav-item').forEach(item => {
    const isActive = item.dataset && item.dataset.target === id;
    item.classList.toggle('active', isActive);
  });

  // Ferme le panneau "Plus" si ouvert
  const more = document.getElementById('more-modal');
  if(more && more.classList.contains('open')){ more.classList.remove('open'); more.setAttribute('aria-hidden','true'); }
}

function toggleMore(){
  const more = document.getElementById('more-modal');
  if(!more) return;
  const wasOpen = more.classList.contains('open');
  if (wasOpen) {
    // Closing the modal: ensure no element inside remains focused (accessibility)
    const active = document.activeElement;
    if (more.contains(active)) {
      // move focus back to the FAB or to main content
      const fab = document.querySelector('.fab-more');
      if (fab) fab.focus();
      else if (document.getElementById('home')) document.getElementById('home').focus();
      else document.body.focus && document.body.focus();
    }

    more.classList.remove('open');
    more.setAttribute('aria-hidden','true');
    // Prefer using inert where supported to prevent focus; otherwise rely on aria-hidden
    try { more.inert = true; } catch(e) { /* inert may not be supported */ }
  } else {
    // Opening the modal
    more.classList.add('open');
    more.setAttribute('aria-hidden','false');
    try { more.inert = false; } catch(e) { }
    // Move focus to the first focusable element inside the modal for keyboard users
    const firstFocusable = more.querySelector('a, button, input, [tabindex]:not([tabindex="-1"])');
    if (firstFocusable) firstFocusable.focus();
  }
}

// Initialize active nav on load
document.addEventListener('DOMContentLoaded', () => {
  showSection('home');
});
  // Enregistrement du service worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js')
      .then(() => console.log("✅ Service Worker enregistré"))
      .catch(err => console.error("❌ Erreur SW:", err));
  }

// RDV (appointments) — simple client-side planner & admin accept flow
// Visual calendar removed: RDV uses native datetime-local input (same UI as Profil)

function submitRdv(){
  const client = document.getElementById('rdv-client').value.trim();
  const vehicle = document.getElementById('rdv-vehicle').value.trim();
  const serviceEl = document.getElementById('rdv-service');
  const service = (serviceEl && serviceEl.options && serviceEl.options[serviceEl.selectedIndex]) ? serviceEl.options[serviceEl.selectedIndex].text : (serviceEl ? serviceEl.value : '');
  // gather checked options as objects {label, price}
  const options = Array.from(document.querySelectorAll('#rdv-options input[type=checkbox]:checked')).map(cb => {
    // price priority: explicit dataset.price (custom), else tariffs.options by value
    const price = cb.dataset && cb.dataset.price ? Number(cb.dataset.price) : (tariffs.options[cb.value] ? Number(tariffs.options[cb.value]) : 0);
    const label = cb.parentElement ? cb.parentElement.textContent.replace(/\+.*€/, '').trim() : (cb.value || '');
    return { label, price };
  });
  // include custom option inputs if filled
  const customLabel = (document.getElementById('opt-custom-label')||{}).value || '';
  const customPrice = Number((document.getElementById('opt-custom-price')||{}).value) || 0;
  if(customLabel.trim()){ options.push({ label: customLabel.trim(), price: customPrice }); }
  const slot = document.getElementById('rdv-slot').value;
  const payment = document.getElementById('rdv-payment').value;
  if(!client || !vehicle || !slot){ showToast('Veuillez renseigner nom, véhicule et choisir une plage horaire'); return; }
  // prevent collisions: check pending requests and confirmed next RDV
  const pending = JSON.parse(localStorage.getItem('bhw_rdv_pending')||'[]');
  const next = JSON.parse(localStorage.getItem('bhw_next_rdv')||'null');
  if(pending.some(p => p.slot === slot) || (next && next.slot === slot)){
    showToast('Ce créneau est déjà demandé ou confirmé — choisissez un autre créneau');
    return;
  }
  const created = new Date().toISOString();
  // compute total price: base service + options
  // determine basePrice from tariffs config
  const basePrice = tariffs.services[(serviceEl && serviceEl.value) || service] || tariffs.services[service] || 0;
  const optionsTotal = (options || []).reduce((s,o)=>s + (o.price || 0), 0);
  const totalPrice = basePrice + optionsTotal;
  pending.push({ client, vehicle, service, options, slot, payment, created, totalPrice });
  try{ localStorage.setItem('bhw_rdv_pending', JSON.stringify(pending)); }catch(e){}
  // remember last client on this device to show "Mes demandes"
  try{ localStorage.setItem('bhw_last_client', client); }catch(e){}
  showToast('RDV demandé — en attente de validation');
  // clear simple fields
  document.getElementById('rdv-client').value = '';
  document.getElementById('rdv-vehicle').value = '';
  // refresh lists
  if(document.getElementById('admin-mode') && document.getElementById('admin-mode').checked) renderPendingRdv();
  renderMyPendingRdv();
  // no visual calendar to regenerate; RDV uses native datetime-local picker
}

function toggleAdminMode(on){
  const container = document.getElementById('pending-rdvs');
  const adminOptions = document.getElementById('admin-options'); // le bloc à afficher/cacher
  if(!container || !adminOptions) return;

  if(!isOwner()){
    const cb = document.getElementById('admin-mode'); 
    if(cb) cb.checked = false;
    showToast('Seul le patron peut activer le mode patron.');
    return;
  }

  container.style.display = on ? 'block' : 'none';
  adminOptions.style.display = on ? 'block' : 'none';
  if(on) renderPendingRdv();
}

function renderMyPendingRdv(){
  const container = document.getElementById('my-pending-rdvs');
  if(!container) return;
  const lastClient = localStorage.getItem('bhw_last_client') || document.getElementById('rdv-client').value.trim();
  const pending = JSON.parse(localStorage.getItem('bhw_rdv_pending')||'[]');
  const mine = pending.filter(p => lastClient && p.client === lastClient);
  if(!mine || mine.length === 0){ container.innerHTML = "Aucune demande en attente pour votre nom."; return; }
  container.innerHTML = '';
  mine.forEach(p => {
    const d = new Date(p.slot);
    const div = document.createElement('div');
    div.style.border='1px dashed #cfe8ff'; div.style.padding='8px'; div.style.marginBottom='8px'; div.style.borderRadius='8px';
    const opts = (p.options && p.options.length) ? `<div style="color:#444;font-size:13px">Options: ${p.options.map(o=>o.label+(o.price?(' (+'+o.price+'€)'):'')).join(', ')}</div>` : '';
    const priceLine = (p.totalPrice !== undefined) ? `<div style="color:#06314d;font-weight:700;margin-top:6px">Prix estimé: ${p.totalPrice.toFixed(2)} €</div>` : '';
  div.innerHTML = `<div style="font-weight:700">${p.client} — ${p.vehicle}</div><div style="color:#444;font-size:13px">${d.toLocaleString()} • ${p.service}</div>${opts}${priceLine}<div style="margin-top:8px;display:flex;gap:8px"><button onclick="cancelPending('${p.created}')" style="background:transparent;border:1px solid #d00;color:#d00;padding:6px 10px;border-radius:6px;cursor:pointer">Annuler la demande</button><button onclick="addRdvPendingToCart('${p.created}')" style="background:#1e90ff;color:#fff;padding:6px 10px;border-radius:6px;border:none;cursor:pointer">Ajouter au panier</button></div>`;
    container.appendChild(div);
  });
}

function cancelPending(created){
  const pending = JSON.parse(localStorage.getItem('bhw_rdv_pending')||'[]');
  const idx = pending.findIndex(p => p.created === created);
  if(idx === -1) return;
  pending.splice(idx,1);
  try{ localStorage.setItem('bhw_rdv_pending', JSON.stringify(pending)); }catch(e){}
  showToast('Demande annulée');
  renderPendingRdv();
  renderMyPendingRdv();
  try{ generateSlots('rdv-calendar', true); }catch(e){}
}

function renderPendingRdv(){
  const container = document.getElementById('pending-rdvs');
  if(!container) return;
  const pending = JSON.parse(localStorage.getItem('bhw_rdv_pending')||'[]');
  if(pending.length === 0){ container.innerHTML = '<div>Aucune demande en attente</div>'; return; }
  container.innerHTML = '';
  pending.forEach((p, idx) => {
    const div = document.createElement('div');
    div.style.border = '1px solid #e6eef9'; div.style.padding='8px'; div.style.marginBottom='8px'; div.style.borderRadius='8px';
    const d = new Date(p.slot);
    const opts = (p.options && p.options.length) ? `<div style="font-size:13px;color:#444">Options: ${p.options.map(o=>o.label+(o.price?(' (+'+o.price+'€)'):'')).join(', ')}</div>` : '';
    const priceLine = (p.totalPrice !== undefined) ? `<div style="color:#06314d;font-weight:700;margin-top:6px">Prix estimé: ${p.totalPrice.toFixed(2)} €</div>` : '';
    div.innerHTML = `<div style="font-weight:700">${p.client} — ${p.vehicle}</div>
      <div style="font-size:13px;color:#444">${d.toLocaleString()} • ${p.service} • ${p.payment}</div>
      ${opts}
      ${priceLine}
      <div style="margin-top:8px;display:flex;gap:8px"><button onclick="acceptRdv(${idx})" style="margin-right:8px;background:#1e90ff;color:#fff;padding:6px 10px;border-radius:6px;border:none;cursor:pointer">Accepter</button><button onclick="rejectRdv(${idx})" style="background:transparent;border:1px solid #d00;color:#d00;padding:6px 10px;border-radius:6px;cursor:pointer">Refuser</button><button onclick="addRdvPendingToCartByIndex(${idx})" style="background:#0b61a6;color:#fff;padding:6px 10px;border-radius:6px;border:none;cursor:pointer">Ajouter au panier</button></div>`;
    container.appendChild(div);
  });
}

function acceptRdv(index){
  if(!isOwner()){ showToast('Accès refusé — action réservée au patron'); return; }
  const pending = JSON.parse(localStorage.getItem('bhw_rdv_pending')||'[]');
  if(index < 0 || index >= pending.length) return;
  const item = pending[index];
  const existingNext = JSON.parse(localStorage.getItem('bhw_next_rdv')||'null');
  if(existingNext && existingNext.slot === item.slot){ showToast('Ce créneau est déjà confirmé'); return; }
  // remove item from pending and keep it as accepted
  pending.splice(index,1);
  // save confirmed appointment as next RDV
  const newNext = { client: item.client, vehicle: item.vehicle, service: item.service, options: item.options || [], slot: item.slot, payment: item.payment, totalPrice: item.totalPrice || 0, acceptedAt: new Date().toISOString() };
  try{ localStorage.setItem('bhw_next_rdv', JSON.stringify(newNext)); } catch(e){}
  // also save per-client mapping so the client's profile (by name) can display their next RDV
  try{
    const byClient = JSON.parse(localStorage.getItem('bhw_next_rdv_by_client')||'{}');
    byClient[item.client] = newNext;
    localStorage.setItem('bhw_next_rdv_by_client', JSON.stringify(byClient));
  }catch(e){}
  try{ localStorage.setItem('bhw_rdv_pending', JSON.stringify(pending)); } catch(e){}
  // update profile Prochain RDV field if present
  const prof = document.querySelector('#profil input[type=datetime-local]');
  if(prof){
    // set value to slot (ISO format already compatible)
    prof.value = item.slot;
  }
  // Add an entry to the maintenance log for the client when the patron accepts the RDV
  try{
    // build invoice HTML and attach it to the maintenance entry
    let invoiceHtml = null;
    try{ invoiceHtml = buildInvoiceHtml(newNext); }catch(e){ console.warn('Erreur génération HTML facture:', e); }
    const histEntry = {
      date: new Date().toISOString(),
      service: item.service || 'RDV',
      notes: 'RDV accepté pour le ' + (new Date(item.slot)).toLocaleString(),
      photos: [],
      invoiceHtml: invoiceHtml
    };
    try{ addToHistory(item.client, histEntry); }catch(e){ console.warn('Erreur ajout carnet:', e); }
    try{ renderMaintenanceLog(); }catch(e){}
  }catch(e){ console.warn('Erreur lors de l\'enregistrement au carnet', e); }
  showToast('RDV accepté — indiqué dans le profil');
  renderPendingRdv();
  // open invoice/summary for the accepted RDV (unchanged behaviour)
  try{ generateInvoice(newNext); }catch(e){}
  // calendar regenerated not needed; using native input
}

function rejectRdv(index){
  if(!isOwner()){ showToast('Accès refusé — action réservée au patron'); return; }
  const pending = JSON.parse(localStorage.getItem('bhw_rdv_pending')||'[]');
  if(index < 0 || index >= pending.length) return;
  pending.splice(index,1);
  try{ localStorage.setItem('bhw_rdv_pending', JSON.stringify(pending)); }catch(e){}
  showToast('RDV refusé');
  renderPendingRdv();
  // calendar regenerated not needed; using native input
}

function loadNextRdvToProfile(){
  const next = JSON.parse(localStorage.getItem('bhw_next_rdv')||'null');
  // prefer a per-client next RDV when the profile name is known
  const prof = document.querySelector('#profil input[type=datetime-local]');
  if(!prof) return;
  // determine the profile name if filled
  const nameInput = document.querySelector('#profil input[type=text]');
  const profileName = (nameInput && nameInput.value && nameInput.value.trim()) ? nameInput.value.trim() : null;
  try{
    if(profileName){
      const byClient = JSON.parse(localStorage.getItem('bhw_next_rdv_by_client')||'{}');
      const clientNext = byClient[profileName];
      if(clientNext && clientNext.slot){ prof.value = clientNext.slot; return; }
    }
  }catch(e){ /* ignore parse errors */ }
  if(next && next.slot){ prof.value = next.slot; }
  // Render action buttons for next RDV (view invoice / add to cart)
  try{
    const actions = document.getElementById('profil-next-actions');
    if(!actions) return;
    actions.innerHTML = '';
    // prefer per-client mapping if available
    let nextRdv = next;
    try{ const nameInput = document.querySelector('#profil input[type=text]'); const profileName = (nameInput && nameInput.value && nameInput.value.trim()) ? nameInput.value.trim() : null; if(profileName){ const byClient = JSON.parse(localStorage.getItem('bhw_next_rdv_by_client')||'{}'); if(byClient[profileName]) nextRdv = byClient[profileName]; } }catch(e){}
    if(nextRdv){
      const btnInvoice = document.createElement('button'); btnInvoice.textContent = 'Voir facture'; btnInvoice.style.marginRight='8px'; btnInvoice.style.padding='8px'; btnInvoice.style.borderRadius='8px'; btnInvoice.style.border='none'; btnInvoice.style.background='#1e90ff'; btnInvoice.style.color='#fff'; btnInvoice.onclick = ()=> generateInvoice(nextRdv);
     
    }
  }catch(e){}
}

// --- RDV price helpers and custom option support ---
function updateRdvPricePreview(){
  const serviceEl = document.getElementById('rdv-service');
  if(!serviceEl) return;
  const serviceBasePrices = { 'interieur':20, 'exterieur':15, 'complet':30, 'Intérieur Voiture':20, 'Extérieur Voiture':15, 'Nettoyage Complet':30 };
  const basePrice = tariffs.services[serviceEl.value] || 0;
  const opts = Array.from(document.querySelectorAll('#rdv-options input[type=checkbox]'));
  const optionsTotal = opts.filter(cb=>cb.checked).reduce((s,cb)=>s + ( (cb.dataset && cb.dataset.price) ? Number(cb.dataset.price) : (tariffs.options[cb.value] ? Number(tariffs.options[cb.value]) : 0) ), 0);
  // include custom inputs if present
  const customPrice = Number((document.getElementById('opt-custom-price')||{}).value) || 0;
  const total = basePrice + optionsTotal + customPrice;
  const preview = document.getElementById('rdv-price-preview'); if(preview) preview.textContent = total.toFixed(2) + ' €';
  return total;
}

function addCustomOption(){
  const label = (document.getElementById('opt-custom-label')||{}).value.trim();
  const price = Number((document.getElementById('opt-custom-price')||{}).value) || 0;
  if(!label){ showToast('Entrez une étiquette pour l\'option'); return; }
  // create checkbox inside rdv-options
  const container = document.getElementById('rdv-options'); if(!container) return;
  const id = 'opt-custom-' + Date.now();
  const lab = document.createElement('label'); lab.style.fontSize = '14px';
  const cb = document.createElement('input'); cb.type = 'checkbox'; cb.value = id; cb.id = id; cb.dataset.price = price; cb.onchange = updateRdvPricePreview;
  lab.appendChild(cb);
  lab.appendChild(document.createTextNode(' ' + label + (price ? (' (+'+price+'€)') : '')));
  container.appendChild(lab);
  // clear custom inputs
  document.getElementById('opt-custom-label').value = '';
  document.getElementById('opt-custom-price').value = '';
  updateRdvPricePreview();
}

// ensure slots & next RDV loaded on DOM ready
// --- Demo auth (localStorage) helpers ---
function hashPass(p){ try{ return btoa(p || ''); }catch(e){ return p || ''; } }
function loadUsers(){ return JSON.parse(localStorage.getItem('bhw_users')||'[]'); }
function saveUsers(u){ try{ localStorage.setItem('bhw_users', JSON.stringify(u)); }catch(e){} }
function getCurrentUser(){ return JSON.parse(localStorage.getItem('bhw_current_user')||'null'); }
function setCurrentUser(u){ if(u) localStorage.setItem('bhw_current_user', JSON.stringify(u)); else localStorage.removeItem('bhw_current_user'); updateAuthUI(); }
function isOwner(){ const cu = getCurrentUser(); return cu && cu.role === 'patron'; }

function updateAuthUI(){
  const cu = getCurrentUser();
  const authBtn = document.getElementById('auth-btn-bottom');
  const authBtnTop = document.getElementById('auth-btn');
  const adminCheckbox = document.getElementById('admin-mode');
  const logoutBtn = document.getElementById('auth-logout');
  const manageTariffsBtn = document.getElementById('auth-manage-tariffs');
  if(authBtn){
    if(cu){ authBtn.textContent = cu.name + ' ▾'; }
    else { authBtn.textContent = 'Se connecter'; }
  }
  if(authBtnTop){
    if(cu){ authBtnTop.textContent = cu.name + ' ▾'; }
    else { authBtnTop.textContent = 'Se connecter'; }
  }
  if(adminCheckbox){
    // show the admin-mode control only if current user is owner
    if(isOwner()) adminCheckbox.parentElement.style.display = 'block';
    else { adminCheckbox.parentElement.style.display = 'none'; adminCheckbox.checked = false; const pendingContainer = document.getElementById('pending-rdvs'); if(pendingContainer) pendingContainer.style.display='none'; }
  }
  if(manageTariffsBtn){ manageTariffsBtn.style.display = isOwner() ? 'inline-block' : 'none'; }
  if(logoutBtn){ logoutBtn.style.display = cu ? 'inline-block' : 'none'; }
  try{ renderMyPendingRdv(); }catch(e){}
}

function openAuthModal(){ const modal = document.getElementById('auth-modal'); if(!modal) return; modal.style.display = 'block'; showAuthTab('login'); }
function closeAuthModal(){ const modal = document.getElementById('auth-modal'); if(modal) modal.style.display='none'; }
function showAuthTab(tab){ document.getElementById('auth-title').textContent = tab === 'login' ? 'Se connecter' : 'Inscription'; document.getElementById('auth-login').style.display = tab === 'login' ? 'block' : 'none'; document.getElementById('auth-register').style.display = tab === 'register' ? 'block' : 'none';
  const roleSelect = document.getElementById('auth-reg-role'); if(roleSelect){ try{ const users = loadUsers(); const hasPatron = users.some(u=>u.role==='patron'); const opt = Array.from(roleSelect.options).find(o=>o.value==='patron'); if(opt) opt.disabled = hasPatron && !isOwner(); }catch(e){} }
}

function registerUser(){
  const name = document.getElementById('auth-reg-name').value.trim();
  const email = document.getElementById('auth-reg-email').value.trim().toLowerCase();
  const pass = document.getElementById('auth-reg-pass').value || '';
  const role = document.getElementById('auth-reg-role').value || 'client';
  if(!name || !email || !pass){ showToast('Remplissez tous les champs d\u2019inscription'); return; }
  const users = loadUsers();
  if(users.some(u=>u.email === email)){ showToast('Un compte existe déjà pour cet email'); return; }
  if(role === 'patron'){ const hasPatron = users.some(u=>u.role==='patron'); if(hasPatron && !isOwner()){ showToast('Un compte patron existe déjà'); return; } }
  const newUser = { name, email, passHash: hashPass(pass), role };
  users.push(newUser); saveUsers(users);
  setCurrentUser({ name, email, role });
  closeAuthModal(); showToast('Compte créé et connecté (démo)');
}

function loginUser(){
  const email = document.getElementById('auth-login-email').value.trim().toLowerCase();
  const pass = document.getElementById('auth-login-pass').value || '';
  if(!email || !pass){ showToast('Email et mot de passe requis'); return; }
  const users = loadUsers();
  const u = users.find(x=>x.email===email && x.passHash === hashPass(pass));
  if(!u){ showToast('Identifiants invalides'); return; }
  setCurrentUser({ name: u.name, email: u.email, role: u.role });
  closeAuthModal(); showToast('Connecté en tant que ' + u.name);
}

function logoutUser(){ setCurrentUser(null); closeAuthModal(); showToast('Déconnecté'); }

// --- Cart helpers for RDV ---
function addRdvPendingToCart(created){
  const pending = JSON.parse(localStorage.getItem('bhw_rdv_pending')||'[]');
  const item = pending.find(p=>p.created === created);
  if(!item){ showToast('RDV introuvable'); return; }
  const name = `RDV: ${item.service} — ${item.client}`;
  const price = Number(item.totalPrice || 0);
  addToCart(null, name, price, 'rdv');
  showToast('RDV ajouté au panier');
}
function addRdvPendingToCartByIndex(idx){
  const pending = JSON.parse(localStorage.getItem('bhw_rdv_pending')||'[]');
  if(idx<0 || idx>=pending.length) return; const item = pending[idx]; addRdvPendingToCart(item.created);
}

function addAcceptedRdvToCart(){
  const next = JSON.parse(localStorage.getItem('bhw_next_rdv')||'null');
  if(!next){ showToast('Aucun RDV confirmé'); return; }
  const name = `RDV confirmé: ${next.service} — ${next.client}`;
  addToCart(null, name, Number(next.totalPrice||0), 'rdv');
  showToast('RDV confirmé ajouté au panier');
}

// --- Tariffs management ---
function openTariffsModal(){ const m = document.getElementById('tariffs-modal'); if(!m) return; loadTariffsToUI(); m.style.display='block'; }
function closeTariffsModal(){ const m = document.getElementById('tariffs-modal'); if(!m) return; m.style.display='none'; }
function loadTariffsToUI(){ try{
  document.getElementById('tariff-interieur').value = tariffs.services.interieur || 0;
  document.getElementById('tariff-exterieur').value = tariffs.services.exterieur || 0;
  document.getElementById('tariff-complet').value = tariffs.services.complet || 0;
  document.getElementById('tariff-siege-bebe').value = tariffs.options['siege-bebe'] || 0;
  document.getElementById('tariff-poils-animaux').value = tariffs.options['poils-animaux'] || 0;
}catch(e){}
}
function saveTariffs(){ try{
  tariffs.services.interieur = Number(document.getElementById('tariff-interieur').value)||0;
  tariffs.services.exterieur = Number(document.getElementById('tariff-exterieur').value)||0;
  tariffs.services.complet = Number(document.getElementById('tariff-complet').value)||0;
  tariffs.options['siege-bebe'] = Number(document.getElementById('tariff-siege-bebe').value)||0;
  tariffs.options['poils-animaux'] = Number(document.getElementById('tariff-poils-animaux').value)||0;
  localStorage.setItem('bhw_tariffs', JSON.stringify(tariffs));
  closeTariffsModal(); showToast('Tarifs enregistrés'); refreshOptionLabels(); updateRdvPricePreview();
}catch(e){ showToast('Erreur sauvegarde tarifs'); }
}
// update option labels (reflect current tariffs)
function refreshOptionLabels(){
  try{
    const siegeLabel = document.querySelector('#rdv-options label[for]') || document.querySelector('#opt-siege') && document.querySelector('#opt-siege').parentElement;
    const siegeCb = document.getElementById('opt-siege'); if(siegeCb && siegeCb.parentElement) siegeCb.parentElement.innerHTML = `<input type="checkbox" value="siege-bebe" id="opt-siege" data-price="${tariffs.options['siege-bebe']}"> Siège bébé (+${tariffs.options['siege-bebe']}€)`;
    const poilsCb = document.getElementById('opt-poils'); if(poilsCb && poilsCb.parentElement) poilsCb.parentElement.innerHTML = `<input type="checkbox" value="poils-animaux" id="opt-poils" data-price="${tariffs.options['poils-animaux']}"> Poils d'animaux (+${tariffs.options['poils-animaux']}€)`;
    // reattach onchange handlers
    const s = document.getElementById('opt-siege'); if(s) s.onchange = updateRdvPricePreview;
    const p = document.getElementById('opt-poils'); if(p) p.onchange = updateRdvPricePreview;
  }catch(e){}
}

// --- Invoice / recap generation ---
function generateInvoice(rdv){
  try{
    const html = buildInvoiceHtml(rdv);
    openInvoiceHtml(html);
    return html;
  }catch(e){ console.error(e); }
}

function buildInvoiceHtml(rdv){
  const d = new Date(rdv.slot);
  const lines = (rdv.options||[]).map(o=>`<tr><td>${o.label}</td><td style="text-align:right">${(o.price||0).toFixed(2)} €</td></tr>`).join('');
  const baseLabel = rdv.service || 'Service';
  const basePrice = Number(rdv.totalPrice || 0) - (rdv.options||[]).reduce((s,o)=>s+(o.price||0),0);
  const html = `<!doctype html><html><head><meta charset="utf-8"><title>Facture RDV</title><style>body{font-family:Arial,sans-serif;padding:20px}table{width:100%;border-collapse:collapse}td{padding:6px;border-bottom:1px solid #eee}</style></head><body><h2>Facture - RDV</h2><div><strong>Client:</strong> ${rdv.client}</div><div><strong>Véhicule:</strong> ${rdv.vehicle}</div><div><strong>Date:</strong> ${d.toLocaleString()}</div><table><tr><td>${baseLabel}</td><td style="text-align:right">${basePrice.toFixed(2)} €</td></tr>${lines}<tr><td style="font-weight:700">Total</td><td style="text-align:right;font-weight:700">${Number(rdv.totalPrice||0).toFixed(2)} €</td></tr></table></body></html>`;
  return html;
}

function openInvoiceHtml(html){
  try{
    const win = window.open('', '_blank');
    if(!win) return;
    win.document.write(html);
    win.document.close();
  }catch(e){ console.error('openInvoiceHtml error', e); }
}
/* Maintenance log (carnet d'entretien) helpers */
function getMaintenanceStore(){
  return JSON.parse(localStorage.getItem('bhw_maintenance') || '{}');
}
function saveMaintenanceStore(store){
  localStorage.setItem('bhw_maintenance', JSON.stringify(store));
}
function addToHistory(client, entry){
  const store = getMaintenanceStore();
  if(!store[client]) store[client] = [];
  store[client].push(entry);
  saveMaintenanceStore(store);
}
function readFilesAsDataURLs(files){
  return Promise.all(Array.from(files || []).map(f => new Promise((res) => {
    const r = new FileReader();
    r.onload = () => res(r.result);
    r.onerror = () => res(null);
    r.readAsDataURL(f);
  })));
}
function addMaintenanceEntryFromForm(){
  const note = document.getElementById('maint-note').value || '';
  const files = document.getElementById('maint-photos').files;
  const cu = getCurrentUser();
  const client = cu && cu.name ? cu.name : (document.querySelector('#profil input[placeholder="Nom du client"]') || {}).value;
  if(!client || client.trim() === ''){ showToast('Connectez-vous pour ajouter au carnet'); return; }
  readFilesAsDataURLs(files).then(urls => {
    const entry = { date: new Date().toISOString(), service: '', notes: note, photos: urls.filter(Boolean) };
    addToHistory(client, entry);
    document.getElementById('maint-note').value = '';
    document.getElementById('maint-photos').value = '';
    renderMaintenanceLog();
    showToast('Entrée ajoutée au carnet');
  });
}
function renderMaintenanceLog(){
  const listEl = document.getElementById('maintenance-log-list');
  if(!listEl) return;
  const cu = getCurrentUser();
  const client = cu && cu.name ? cu.name : (document.querySelector('#profil input[placeholder="Nom du client"]') || {}).value;
  const store = getMaintenanceStore();
  const items = (client && store[client]) ? store[client].slice().reverse() : [];
  if(!items || items.length === 0){ listEl.innerHTML = '<div style="color:#666">Aucun historique</div>'; return; }
  listEl.innerHTML = '';
  items.forEach(e => {
    const d = new Date(e.date);
    const wrapper = document.createElement('div');
    wrapper.style.border = '1px solid #e6eef9';
    wrapper.style.padding = '8px';
    wrapper.style.marginBottom = '8px';
    wrapper.style.borderRadius = '8px';
    const photosHtml = (e.photos && e.photos.length) ? '<div style="display:flex;gap:8px;margin-top:8px;">' + e.photos.map(p => `<img src="${p}" style="width:84px;height:56px;object-fit:cover;border-radius:6px;">`).join('') + '</div>' : '';
    wrapper.innerHTML = `<div style="font-weight:700">${e.service || ''} • ${d.toLocaleString()}</div><div style="font-size:13px;color:#444">${(e.notes||'')}</div>${photosHtml}`;
    // if an invoice HTML was saved with this entry, add a button to open it
    if(e.invoiceHtml){
      const btnContainer = document.createElement('div');
      btnContainer.style.marginTop = '8px';
      const btn = document.createElement('button');
      btn.textContent = 'Voir facture';
      btn.style.padding = '8px'; btn.style.borderRadius = '8px'; btn.style.border = 'none'; btn.style.background = '#1e90ff'; btn.style.color = '#fff'; btn.style.cursor = 'pointer';
      btn.onclick = function(){ openInvoiceHtml(e.invoiceHtml); };
      btnContainer.appendChild(btn);
      wrapper.appendChild(btnContainer);
    }
    listEl.appendChild(wrapper);
  });
}

// ensure slots & next RDV loaded on DOM ready
document.addEventListener('DOMContentLoaded', ()=>{
  try{ loadNextRdvToProfile(); }catch(e){}
  try{ renderMyPendingRdv(); }catch(e){}
  try{ updateAuthUI(); }catch(e){}
  try{ refreshOptionLabels(); }catch(e){}
});
</script>
<!-- Removed duplicated auth/profile small scripts (they referenced alternative IDs like auth-btn/authBtn/profile-tab). Kept a single consistent auth implementation earlier that uses `auth-btn-bottom` and `profile-tab-bottom`. -->
<!-- SCRIPT -->

<!-- Duplicate bottom navigation & small auth script removed (kept the main .bottom-nav earlier) -->

</body>
</html>